<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>HRRP Analysis Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
      label {
        font-weight: 600;
      }
      select, input[type="number"], input[list] {
        width: 100%;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #cccccc;
        margin-top: 4px;
        margin-bottom: 12px;
      }
      .param-group {
        margin-top: 10px;
      }
      #results {
        margin-top: 30px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      th, td {
        border: 1px solid #ddd;
        padding: 6px 8px;
        text-align: left;
      }
      th {
        background-color: #f0f3fa;
      }
      .small-text {
        font-size: 0.9em;
        color: #555;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>Hospital Readmissions Reduction Program Explorer</h1>
      <p>
        Use this page to explore HRRP data in different ways. Choose an analysis type,
        fill in any required parameters, and click <strong>Run analysis</strong>.
      </p>

      <!-- Analysis selection form -->
      <form id="analysis-form" class="card">
        <label for="analysisType">Analysis type:</label>
        <select id="analysisType" name="analysisType">
          <option value="lookup">Single hospital lookup</option>
          <option value="summary">Summary statistics & volume–ERR analysis</option>
          <option value="by_state">State comparison</option>
          <option value="top_hospitals">Top N hospitals by ERR</option>
        </select>

        <!-- Parameters for lookup -->
        <div class="param-group" id="params-lookup">
          <label for="hospital">Hospital (Facility Name):</label>
          <input
            list="hospital-list"
            id="hospital"
            name="hospital"
            placeholder="Start typing a hospital name…"
          >
          <datalist id="hospital-list">
            {% for h in hospitals %}
              <option value="{{ h }}">
            {% endfor %}
          </datalist>
          <p class="small-text">
            Begin typing to see matching hospitals from the HRRP dataset.
          </p>

          <label for="measure">Measure (required):</label>
          <select id="measure" name="measure">
            <option value="">Select a measure…</option>
            {% for code, desc in measures.items() %}
              <option value="{{ code }}">{{ desc }} ({{ code }})</option>
            {% endfor %}
          </select>
          <p class="small-text">
            Measures correspond to specific conditions, for example:
            Heart Failure (READM-30-HF-HRRP), Heart Attack / AMI (READM-30-AMI-HRRP),
            Pneumonia (READM-30-PN-HRRP).<br>
            This lookup uses the JSON API <code>/api/hrrp</code> for one hospital and measure.
          </p>
        </div>

        <!-- Parameters for summary -->
        <div class="param-group" id="params-summary" style="display: none;">
          <label for="summary-measure">Measure (optional):</label>
          <select id="summary-measure" name="summary-measure">
            <option value="">All measures</option>
            {% for code, desc in measures.items() %}
              <option value="{{ code }}">{{ desc }} ({{ code }})</option>
            {% endfor %}
          </select>
          <p class="small-text">
            This calls <code>/api/summary</code> and shows summary statistics for
            ERR and related metrics. <br> It also includes a scatterplot
            examining the relationship between hospital volume (number of discharges) and ERR. Leave as 
            "All measures" for an overall view, or pick a single measure.

          </p>
        </div>

        <!-- Parameters for state comparison -->
        <div class="param-group" id="params-by_state" style="display: none;">
          <label for="state-measure">Measure (optional):</label>
          <select id="state-measure" name="state-measure">
            <option value="">All measures</option>
            {% for code, desc in measures.items() %}
              <option value="{{ code }}">{{ desc }} ({{ code }})</option>
            {% endfor %}
          </select>
          <p class="small-text">
            This calls <code>/api/by_state</code> and computes mean Excess Readmission Ratio by state.
            Use a specific condition (e.g., heart failure) or all measures combined.
          </p>
        </div>

        <!-- Parameters for top hospitals -->
        <div class="param-group" id="params-top_hospitals" style="display: none;">
          <label for="top-measure">Measure (required):</label>
          <select id="top-measure" name="top-measure">
            <option value="">Select a measure…</option>
            {% for code, desc in measures.items() %}
              <option value="{{ code }}">{{ desc }} ({{ code }})</option>
            {% endfor %}
          </select>

          <label for="top-n">Number of hospitals (N):</label>
          <input type="number" id="top-n" name="top-n" value="10" min="1" step="1">

          <label for="top-direction">Direction:</label>
          <select id="top-direction" name="top-direction">
            <option value="high">Highest ERR (worst performers)</option>
            <option value="low">Lowest ERR (best performers)</option>
          </select>

          <p class="small-text">
            This calls <code>/api/top_hospitals</code>, which has a tunable parameter
            <code>n</code> (how many hospitals to show).
          </p>
        </div>

        <button type="submit" class="btn">Run analysis</button>
      </form>

      <!-- Results -->
      <div id="results"></div>

      <div class="image-box">
        <img src="{{ url_for('static', filename='hospital.png') }}" alt="Hospital image">
      </div>
    </div>

    <script>
      // Show/hide parameter groups based on selected analysis
      const analysisSelect = document.getElementById('analysisType');
      const paramGroups = {
        lookup: document.getElementById('params-lookup'),
        summary: document.getElementById('params-summary'),
        by_state: document.getElementById('params-by_state'),
        top_hospitals: document.getElementById('params-top_hospitals'),
      };
      let byStateChart = null;
      let topHospitalsChart = null;
      let volumeErrChart = null;  

      function updateParamVisibility() {
        const selected = analysisSelect.value;
        for (const key in paramGroups) {
          paramGroups[key].style.display = (key === selected) ? 'block' : 'none';
        }
      }

      analysisSelect.addEventListener('change', updateParamVisibility);
      updateParamVisibility();  // initialize on page load

      // Handle form submission and call the appropriate API
      const form = document.getElementById('analysis-form');
      const resultsDiv = document.getElementById('results');

      form.addEventListener('submit', async function(event) {
        event.preventDefault();
        resultsDiv.innerHTML = "<div class='card'><p>Loading...</p></div>";

        const analysisType = analysisSelect.value;

        try {
          if (analysisType === 'lookup') {
            await runLookup();
          } else if (analysisType === 'summary') {
            await runSummary();
          } else if (analysisType === 'by_state') {
            await runByState();
          } else if (analysisType === 'top_hospitals') {
            await runTopHospitals();
          }
        } catch (err) {
          console.error(err);
          resultsDiv.innerHTML = "<div class='card error'><p>Something went wrong. Check the console.</p></div>";
        }
      });

      async function runLookup() {
        const hospital = document.getElementById('hospital').value.trim();
        const measure = document.getElementById('measure').value.trim();

        if (!hospital || !measure) {
          resultsDiv.innerHTML = "<div class='card error'><p>Please enter both a hospital and a measure.</p></div>";
          return;
        }

        const params = new URLSearchParams({ hospital, measure });
        const response = await fetch(`/api/hrrp?${params.toString()}`);
        const data = await response.json();

        if (!response.ok) {
          resultsDiv.innerHTML = `<div class='card error'><p>${data.error || 'Error occurred'}</p></div>`;
          return;
        }

        const err = data.excess_readmission_ratio;
        let interpretation = "No Excess Readmission Ratio available.";

        if (err !== null && err !== undefined) {
          if (err < 0.98) {
            interpretation = "better than the national average.";
          } else if (err > 1.02) {
            interpretation = "worse than the national average.";
          } else {
            interpretation = "about the same as the national average.";
          }
        }

        resultsDiv.innerHTML = `
          <div class="card">
            <h2>Single hospital lookup</h2>

            <p><strong>Hospital:</strong> ${data.hospital}</p>
            <p><strong>Measure:</strong> ${data.measure}</p>

            <p><strong>Excess Readmission Ratio:</strong> ${
              err === null ? "N/A" : err.toFixed(3)
            }</p>
            <p>This hospital is ${interpretation}</p>

            <h3>Additional information</h3>

            <ul>
              <li>
                <strong>Predicted Readmission Rate:</strong> 
                ${data.predicted_readmission === null ? "N/A" : data.predicted_readmission.toFixed(4)}
                <br>
                <span class="small-text">
                  This is the rate CMS predicts this hospital would have, based on its actual patients’ conditions
                  (severity, comorbidities, age, etc.).
                </span>
              </li>

              <li>
                <strong>Expected Readmission Rate:</strong> 
                ${data.expected_readmission_rate === null ? "N/A" : data.expected_readmission_rate.toFixed(4)}
                <br>
                <span class="small-text">
                  This is the national average rate CMS would expect for a hospital with the same mix of patients.
                  It serves as the benchmark for fairness.
                </span>
              </li>

              <li>
                <strong>How to interpret ERR:</strong>
                <br>
                <span class="small-text">
                  ERR = Predicted ÷ Expected.  
                  <br>
                  • ERR &lt; 1 → Hospital performs better than expected (fewer readmissions).  
                  <br>
                  • ERR ≈ 1 → Hospital performs as expected.  
                  <br>
                  • ERR &gt; 1 → Hospital performs worse than expected (more readmissions).  
                </span>
              </li>
            </ul>
          </div>
        `;
      }

      async function runSummary() {
        const measure = document.getElementById('summary-measure').value.trim();
        const params = new URLSearchParams();
        if (measure) {
          params.set('measure', measure);
        }

        // 1) Get numeric summary from /api/summary
        const response = await fetch(`/api/summary?${params.toString()}`);
        const data = await response.json();

        if (!response.ok) {
          resultsDiv.innerHTML = `<div class='card error'><p>${data.error || 'Error occurred'}</p></div>`;
          return;
        }

        // Helper to render the summary table
        function renderSummaryTable(title, summary) {
          if (!summary) return '';
          return `
            <h3>${title}</h3>
            <table>
              <tr><th>Count</th><td>${summary.count}</td></tr>
              <tr><th>Mean</th><td>${summary.mean.toFixed(4)}</td></tr>
              <tr><th>Std</th><td>${summary.std === null ? 'N/A' : summary.std.toFixed(4)}</td></tr>
              <tr><th>Min</th><td>${summary.min.toFixed(4)}</td></tr>
              <tr><th>Q1</th><td>${summary.q1.toFixed(4)}</td></tr>
              <tr><th>Median</th><td>${summary.median.toFixed(4)}</td></tr>
              <tr><th>Q3</th><td>${summary.q3.toFixed(4)}</td></tr>
              <tr><th>Max</th><td>${summary.max.toFixed(4)}</td></tr>
            </table>
          `;
        }

        const errSummary = data.err_summary;

        // 2) Build the HTML for summary + one new scatterplot
        resultsDiv.innerHTML = `
          <div class="card">
            <h2>Summary statistics</h2>
            <p><strong>Measure filter:</strong> ${data.measure}</p>
            <p><strong>Number of rows:</strong> ${data.n_rows}</p>

            ${renderSummaryTable("Excess Readmission Ratio", errSummary)}
            ${renderSummaryTable("Predicted Readmission Rate", data.predicted_summary)}
            ${renderSummaryTable("Expected Readmission Rate", data.expected_summary)}

            <h3>Distribution of Excess Readmission Ratio (ERR)</h2>
            <p class="small-text">
              This histogram shows how ERR values are distributed across all hospital–measure records.
              The dashed line marks the overall mean ERR.
            </p>
            <img src="/static/err_histogram.png"
                alt="Histogram of Excess Readmission Ratio"
                style="max-width: 100%; height: auto; margin-top: 10px;">

            <h3>ERR by Disease Category</h2>
            <p class="small-text">
              Each box shows the distribution of ERR for a specific HRRP disease category
              (heart attack, heart failure, pneumonia, COPD, CABG surgery, and hip/knee replacement).
            </p>
            <img src="/static/err_boxplot_by_disease.png"
                alt="ERR by disease category boxplot"
                style="max-width: 100%; height: auto; margin-top: 10px;">

            <h2>Hospital volume vs Excess Readmission Ratio (ERR)</h3>
            <p class="small-text">
              Each point is a hospital–measure record. The x-axis shows the number of
              discharges (hospital volume), and the y-axis shows the ERR. This helps
              show whether larger hospitals tend to have higher or lower readmission
              ratios compared to smaller hospitals.
            </p>
            <canvas id="volumeErrCanvas" height="140"></canvas>
          </div>
        `;

        // 3) Fetch data for the scatterplot
        try {
          const respVolErr = await fetch(`/api/volume_vs_err?${params.toString()}`);
          if (!respVolErr.ok) {
            console.error("Error in /api/volume_vs_err:", await respVolErr.text());
            return;
          }
          const veData = await respVolErr.json();
          drawVolumeVsErrScatter(veData.points || []);
        } catch (e) {
          console.error("Exception while fetching volume vs ERR data:", e);
        }
      }

      function drawVolumeVsErrScatter(points) {
        if (!Array.isArray(points) || points.length === 0) {
          console.warn("No points for volume vs ERR scatter.");
          return;
        }

        // Group points by disease / measure label so each disease gets its own dataset
        const datasetsMap = {};  // label -> [{x, y}, ...]
        const allXY = [];        // for regression

        for (const p of points) {
          const label = p.measure_label || p.measure || "Unknown measure";
          if (!datasetsMap[label]) {
            datasetsMap[label] = [];
          }
          const xy = {
            x: p.x,
            y: p.y,
            hospital: p.hospital,
            state: p.state,
            measure: p.measure,
            measure_label: p.measure_label
          };

          datasetsMap[label].push(xy);
          allXY.push(xy);
        }

        const datasets = Object.keys(datasetsMap).map(label => ({
          label: label,
          data: datasetsMap[label],
          showLine: false,
          pointRadius: 3,
          pointHoverRadius: 4,
        }));

        // Compute a simple linear regression y = a + b x over all points
        if (allXY.length >= 2) {
          let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
          for (const pt of allXY) {
            sumX += pt.x;
            sumY += pt.y;
            sumXY += pt.x * pt.y;
            sumX2 += pt.x * pt.x;
          }
          const n = allXY.length;
          const denom = (n * sumX2 - sumX * sumX);
          if (denom !== 0) {
            const slope = (n * sumXY - sumX * sumY) / denom;
            const intercept = (sumY - slope * sumX) / n;

            // Use min and max X to draw the regression line
            let minX = Infinity;
            let maxX = -Infinity;
            for (const pt of allXY) {
              if (pt.x < minX) minX = pt.x;
              if (pt.x > maxX) maxX = pt.x;
            }

            const lineData = [
              { x: minX, y: intercept + slope * minX },
              { x: maxX, y: intercept + slope * maxX },
            ];

            datasets.push({
              label: "Linear trend",
              data: lineData,
              showLine: true,
              pointRadius: 0,
              pointHoverRadius: 0,
              borderWidth: 2,
              fill: false,
            });
          }
        }

        const ctx = document.getElementById('volumeErrCanvas').getContext('2d');

        if (volumeErrChart) {
          volumeErrChart.destroy();
        }

        volumeErrChart = new Chart(ctx, {
          type: 'scatter',
          data: {
            datasets: datasets
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: true,
                position: 'top',
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const dsLabel = context.dataset.label || '';
                    const raw = context.raw || {}; // this is the actual point object
                    const x = context.parsed.x;
                    const y = context.parsed.y;

                    // regression line
                    if (dsLabel === "Linear trend") {
                      return `Trend: discharges ${x.toFixed(0)}, ERR ${y.toFixed(3)}`;
                    }

                    const hospital = raw.hospital ? raw.hospital : "Unknown hospital";
                    const state = raw.state ? raw.state : "";
                    return [
                      `${hospital}${state ? ` (${state})` : ""}`,
                      `${dsLabel}`,
                      `Discharges: ${x.toFixed(0)}, ERR: ${y.toFixed(3)}`
                    ];
                  }
                }
}

            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'Number of discharges (hospital volume)'
                }
              },
              y: {
                title: {
                  display: true,
                  text: 'Excess Readmission Ratio (ERR)'
                }
              }
            }
          }
        });
      }


      async function runByState() {
        const measure = document.getElementById('state-measure').value.trim();
        const params = new URLSearchParams();
        if (measure) {
          params.set('measure', measure);
        }

        const response = await fetch(`/api/by_state?${params.toString()}`);
        const data = await response.json();

        if (!response.ok) {
          resultsDiv.innerHTML = `<div class='card error'><p>${data.error || 'Error occurred'}</p></div>`;
          return;
        }

        // Build table rows
        let rowsHtml = '';
        data.by_state.forEach(row => {
          rowsHtml += `
            <tr>
              <td>${row.state}</td>
              <td>${row.mean_err.toFixed(4)}</td>
              <td>${row.n_hospitals}</td>
              <td>${row.n_rows}</td>
            </tr>
          `;
        });

        // Insert card + table + canvas for chart
        resultsDiv.innerHTML = `
          <div class="card">
            <h2>State comparison</h2>
            <p><strong>Measure filter:</strong> ${data.measure}</p>
            <p><strong>Number of states:</strong> ${data.n_states}</p>

            <canvas id="byStateChart" height="120"></canvas>

            <table>
              <thead>
                <tr>
                  <th>State</th>
                  <th>Mean ERR</th>
                  <th># Hospitals</th>
                  <th># Rows</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml}
              </tbody>
            </table>
          </div>
        `;

        // Sort states by mean_err (descending) and take top 10 worst
        const sorted = [...data.by_state].sort((a, b) => b.mean_err - a.mean_err);
        const topStates = sorted.slice(0, 10);

        // For text summary: also get best state and overall mean
        const worst = sorted[0];
        const best = sorted[sorted.length - 1];
        const overallMean = sorted.reduce((sum, row) => sum + row.mean_err, 0) / sorted.length;

        // Rebuild the card so we can show these summaries
        resultsDiv.innerHTML = `
          <div class="card">
            <h2>State comparison</h2>
            <p><strong>Measure filter:</strong> ${data.measure}</p>
            <p><strong>Number of states:</strong> ${data.n_states}</p>
            <p class="small-text">
              Top 10 bars below show the states with the <strong>highest</strong> mean Excess Readmission Ratios
              (worst performance). Overall mean across all states is ${overallMean.toFixed(4)}.
              Best state is ${best.state} (mean ERR ${best.mean_err.toFixed(4)}),
              worst state is ${worst.state} (mean ERR ${worst.mean_err.toFixed(4)}).
            </p>

            <canvas id="byStateChart" height="120"></canvas>

            <h3>All states (table)</h3>
            <table>
              <thead>
                <tr>
                  <th>State</th>
                  <th>Mean ERR</th>
                  <th># Hospitals</th>
                  <th># Rows</th>
                </tr>
              </thead>
              <tbody>
                ${data.by_state.map(row => `
                  <tr>
                    <td>${row.state}</td>
                    <td>${row.mean_err.toFixed(4)}</td>
                    <td>${row.n_hospitals}</td>
                    <td>${row.n_rows}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;

        // Prepare data for chart (top 10 worst states)
        const labels = topStates.map(row => row.state);
        const meanErrs = topStates.map(row => row.mean_err);

        // Destroy old chart if it exists
        if (byStateChart) {
          byStateChart.destroy();
        }

        const ctx = document.getElementById('byStateChart').getContext('2d');
        byStateChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Top 10 states by mean ERR (worst)',
              data: meanErrs,
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: true,
              }
            },
            scales: {
              x: {
                ticks: {
                  maxRotation: 0,
                  minRotation: 0,
                }
              },
              y: {
                title: {
                  display: true,
                  text: 'Mean ERR'
                }
              },
              y: {
                min: 0.95,
                max: 1.06,
                title: { display: true, text: 'Mean ERR' }
              }
            }
          }
        });
      }

      async function runTopHospitals() {
        const measure = document.getElementById('top-measure').value.trim();
        const nStr = document.getElementById('top-n').value.trim();
        const direction = document.getElementById('top-direction').value;

        if (!measure) {
          resultsDiv.innerHTML = "<div class='card error'><p>Please select a measure (e.g., Heart Failure / READM-30-HF-HRRP) for the Top N analysis.</p></div>";
          return;
        }

        const params = new URLSearchParams();
        if (measure) {
          params.set('measure', measure);
        }
        if (nStr) {
          params.set('n', nStr);
        }
        params.set('direction', direction);

        const response = await fetch(`/api/top_hospitals?${params.toString()}`);
        const data = await response.json();

        if (!response.ok) {
          resultsDiv.innerHTML = `<div class='card error'><p>${data.error || 'Error occurred'}</p></div>`;
          return;
        }

        let rowsHtml = '';
        data.hospitals.forEach((h, index) => {
          rowsHtml += `
            <tr>
              <td>${index + 1}</td>
              <td>${h.facility_name}</td>
              <td>${h.state}</td>
              <td>${h.measure}</td>
              <td>${h.excess_readmission_ratio.toFixed(4)}</td>
              <td>${h.predicted_readmission_rate === null ? 'N/A' : h.predicted_readmission_rate.toFixed(4)}</td>
              <td>${h.expected_readmission_rate === null ? 'N/A' : h.expected_readmission_rate.toFixed(4)}</td>
            </tr>
          `;
        });

        // Insert card + canvas + table
        resultsDiv.innerHTML = `
          <div class="card">
            <h2>Top N hospitals by Excess Readmission Ratio</h2>
            <p><strong>Measure filter:</strong> ${data.measure}</p>
            <p><strong>Direction:</strong> ${
              data.direction === 'high'
                ? 'Highest ERR (worst performers)'
                : 'Lowest ERR (best performers)'
            }</p>
            <p><strong>Number returned:</strong> ${data.n_returned}</p>

            <canvas id="topHospitalsChart" height="120"></canvas>

            <table>
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Hospital</th>
                  <th>State</th>
                  <th>Measure</th>
                  <th>ERR</th>
                  <th>Predicted rate</th>
                  <th>Expected rate</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml}
              </tbody>
            </table>
          </div>
        `;

        // Prepare data for chart
        const labels = data.hospitals.map(h => h.facility_name);
        const errs = data.hospitals.map(h => h.excess_readmission_ratio);

        // Destroy old chart if it exists
        if (topHospitalsChart) {
          topHospitalsChart.destroy();
        }

        const ctx = document.getElementById('topHospitalsChart').getContext('2d');
        topHospitalsChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Excess Readmission Ratio',
              data: errs,
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `ERR: ${context.parsed.x.toFixed(4)}`;
                  }
                }
              }
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'ERR'
                }
              },
              y: {
                title: {
                  display: true,
                  text: 'Hospital'
                },
                ticks: {
                  autoSkip: false,
                  font: {
                    size: 10
                  }
                }
              }
            }
          }
        });

    }
    </script>
  </body>
</html>
